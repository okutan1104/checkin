<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>会員制 QRチェックイン</title>
  <style>
    body {font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
          margin:0;background:#f6f7fb;}
    .wrap{max-width:960px;margin:auto;padding:1rem;}
    h1{font-size:1.3rem;margin-bottom:0.3rem;}
    .tabs{display:flex;gap:.5rem;margin:1rem 0;}
    .tab{flex:1;text-align:center;background:#e2e8f0;padding:.5rem;border-radius:6px;cursor:pointer;}
    .tab.active{background:#2563eb;color:#fff;}
    .card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:1rem;}
    input,button{width:100%;padding:.6rem;margin:.3rem 0;border:1px solid #ccc;border-radius:5px;font-size:.95rem;}
    button{background:#2563eb;color:#fff;border:none;cursor:pointer;}
    button.stop{background:#ef4444;}
    video{width:100%;border-radius:8px;background:#000;}
    textarea{width:100%;height:70px;}
    table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:.9rem;}
    th,td{border-bottom:1px solid #eee;padding:.4rem;text-align:left;}
    #qrcode{margin:auto;padding:10px;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>会員制 QRチェックインシステム（GitHub Pages対応）</h1>

  <div class="tabs">
    <div class="tab active" id="tab-gen">QR生成</div>
    <div class="tab" id="tab-scan">チェックイン</div>
  </div>

  <div id="page-gen" class="card">
    <h2>会員QR生成</h2>
    <input id="name" placeholder="名前（例：山田太郎）">
    <input id="memberId" placeholder="会員ID（例：A001）">
    <input id="event" placeholder="イベント名（例：イベントA）">
    <button id="makeQr">QRを生成</button>
    <div id="qrcode"></div>
    <textarea id="qrText" readonly></textarea>
    <button id="download" style="display:none;">QR画像を保存</button>
  </div>

  <div id="page-scan" class="card" style="display:none;">
    <h2>チェックイン</h2>
    <video id="video" playsinline></video>
    <button id="start">カメラ開始</button>
    <button id="stop" class="stop">停止</button>
    <table>
      <thead><tr><th>時刻</th><th>名前</th><th>ID</th><th>イベント</th></tr></thead>
      <tbody id="log"></tbody>
    </table>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/qr-scanner/qr-scanner.min.js"></script>
<script>
  const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/【あなたのAppsScriptのURL】/exec";

  // タブ切り替え
  const tabs = document.querySelectorAll('.tab');
  const pages = {gen: document.getElementById('page-gen'), scan: document.getElementById('page-scan')};
  tabs.forEach(tab=>{
    tab.addEventListener('click', ()=>{
      tabs.forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const id = tab.id === 'tab-gen' ? 'gen' : 'scan';
      pages.gen.style.display = id==='gen'?'block':'none';
      pages.scan.style.display = id==='scan'?'block':'none';
    });
  });

  // QR生成
  document.getElementById('makeQr').onclick = ()=>{
    const name=document.getElementById('name').value.trim();
    const id=document.getElementById('memberId').value.trim();
    const ev=document.getElementById('event').value.trim();
    if(!name||!id){alert('名前と会員IDを入力してください');return;}
    const payload=`MEMBER|${ev}|${name}|${id}|${Date.now()}`;
    document.getElementById('qrText').value=payload;
    document.getElementById('qrcode').innerHTML='';
    new QRCode(document.getElementById('qrcode'),{text:payload,width:200,height:200});
    document.getElementById('download').style.display='block';
  };

  // QR保存
  document.getElementById('download').onclick=()=>{
    const img=document.querySelector('#qrcode img');
    if(img){
      const a=document.createElement('a');
      a.href=img.src;
      a.download='member_qr.png';
      a.click();
    }
  };

  // カメラとスキャン
  const video=document.getElementById('video');
  let scanner=null;

  document.getElementById('start').onclick=async()=>{
    if(scanner) return;
    QrScanner.WORKER_PATH='https://unpkg.com/qr-scanner/qr-scanner-worker.min.js';
    scanner=new QrScanner(video,result=>handleScan(result));
    await scanner.start();
  };
  document.getElementById('stop').onclick=()=>{if(scanner){scanner.stop();scanner.destroy();scanner=null;}};

  function handleScan(result){
    const data=result.data||result;
    const parts=data.split('|');
    if(parts[0]!=='MEMBER'){alert('無効なQR');return;}
    const [_,event,name,id]=parts;
    const now=new Date().toLocaleString();
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${now}</td><td>${name}</td><td>${id}</td><td>${event}</td>`;
    document.getElementById('log').prepend(tr);

    // Google Sheetsへ送信
    fetch(GOOGLE_SHEET_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({timestamp:now,name,id,event})
    }).then(r=>r.text()).then(console.log);
  }
</script>
</body>
</html>
