<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä¼šå“¡åˆ¶QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</title>
<style>
body{font-family:system-ui;background:#f5f6fa;margin:0;padding:1rem;color:#333;}
h1{text-align:center;margin-bottom:1rem;}
.container{max-width:480px;margin:auto;background:white;border-radius:16px;box-shadow:0 2px 6px rgba(0,0,0,.15);padding:1rem;}
input,button{width:100%;padding:.6rem;margin:.5rem 0;font-size:1rem;}
button{cursor:pointer;}
video{width:100%;border-radius:10px;margin-top:1rem;display:block;}
canvas{display:block;margin:1rem auto;}
#log{font-size:.9rem;margin-top:.5rem;white-space:pre-wrap;}
.tab-buttons{display:flex;justify-content:space-around;margin:1rem 0;}
.tab-buttons button{width:48%;padding:.5rem;}
.tab-content{display:none;}
.tab-content.active{display:block;}
</style>
</head>
<body>
<h1>ä¼šå“¡åˆ¶QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h1>
<div class="container">

<div class="tab-buttons">
  <button id="cameraTabBtn">ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</button>
  <button id="imageTabBtn">ç”»åƒã§ã‚¹ã‚­ãƒ£ãƒ³</button>
</div>

<div id="cameraTab" class="tab-content">
  <video id="preview" autoplay playsinline></video>
  <p id="statusCam">ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...</p>
</div>

<div id="imageTab" class="tab-content">
  <input type="file" id="fileInput" accept="image/*">
</div>

<hr>
<h3>ä¼šå“¡QRç”Ÿæˆ</h3>
<input id="memberId" placeholder="ä¼šå“¡IDï¼ˆä¾‹ï¼šA001ï¼‰">
<input id="memberName" placeholder="æ°åï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒï¼‰">
<input id="eventName" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹ï¼šç§‹ç¥­ã‚Š2025ï¼‰">
<button onclick="generateQR()">QRã‚’ç”Ÿæˆ</button>
<canvas id="qrcanvas"></canvas>

<pre id="log"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script>
// ã‚ãªãŸã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆGAS URL
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycby_Brj_2fmQ5fvNI7Y_lSMPwf_BEZ-XjQEI4bq8hvUdJCKz1JK5TUBFpqIQOlD4A17d/exec";

function log(t){document.getElementById("log").textContent += t + "\n";}

// ã‚¿ãƒ–åˆ‡æ›¿
const cameraTabBtn = document.getElementById("cameraTabBtn");
const imageTabBtn = document.getElementById("imageTabBtn");
const cameraTab = document.getElementById("cameraTab");
const imageTab = document.getElementById("imageTab");

cameraTabBtn.addEventListener("click",()=>{cameraTab.classList.add("active"); imageTab.classList.remove("active");});
imageTabBtn.addEventListener("click",()=>{cameraTab.classList.remove("active"); imageTab.classList.add("active");});
cameraTab.classList.add("active");

// QRç”Ÿæˆ
function generateQR(){
  const id = memberId.value.trim();
  const name = memberName.value.trim();
  const event = eventName.value.trim();
  if(!id||!name||!event){alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  const json = JSON.stringify({id,name,event});
  new QRious({element:document.getElementById("qrcanvas"),value:json,size:200});
  log("âœ… QRç”Ÿæˆ: " + json);
}

// é€ä¿¡ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯å¯¾å¿œï¼‰
async function sendToSheet(entry){
  try{
    const resGet = await fetch(GOOGLE_SHEET_URL + "?action=get");
    const existing = await resGet.json();
    if(existing.some(r=>r.member_id===entry.member_id)){
      document.getElementById("statusCam").textContent = `âš ï¸ æ—¢ã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿: ${entry.member_id}`;
      log(`âš ï¸ ${entry.member_id} ã¯æ—¢ã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿`);
      return;
    }
    const resPost = await fetch(GOOGLE_SHEET_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(entry)
    });
    log("ğŸ“¤é€ä¿¡çµæœ: " + await resPost.text());
    document.getElementById("statusCam").textContent = `âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³: ${entry.name} (${entry.member_id})`;
  }catch(e){
    log("âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e);
  }
}

// ã‚«ãƒ¡ãƒ©
const video=document.getElementById("preview");
const camCanvas=document.createElement("canvas");
const camCtx=camCanvas.getContext("2d");

async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
    video.play();
    requestAnimationFrame(camTick);
    document.getElementById("statusCam").textContent="ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ";
  }catch(e){
    document.getElementById("statusCam").textContent="âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + e;
  }
}

function camTick(){
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    camCanvas.width=video.videoWidth;
    camCanvas.height=video.videoHeight;
    camCtx.drawImage(video,0,0,camCanvas.width,camCanvas.height);
    const imgData=camCtx.getImageData(0,0,camCanvas.width,camCanvas.height);
    const code=jsQR(imgData.data,imgData.width,imgData.height);
    if(code) processQRCode(code.data);
  }
  requestAnimationFrame(camTick);
}

// QRå…±é€šå‡¦ç†
function processQRCode(qrText){
  try{
    const data=JSON.parse(qrText);
    const entry={member_id:data.id,name:data.name,event:data.event,status:"checked_in"};
    sendToSheet(entry);
  }catch{
    document.getElementById("statusCam").textContent="âš ï¸ ä¸æ­£ãªQRã§ã™";
  }
}

// ç”»åƒã‚¹ã‚­ãƒ£ãƒ³
const imgCanvas = document.createElement("canvas");
const imgCtx = imgCanvas.getContext("2d");
document.getElementById("fileInput").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function() {
    const img = new Image();
    img.onload = function() {
      imgCanvas.width = img.width;
      imgCanvas.height = img.height;
      imgCtx.drawImage(img,0,0);
      try {
        const imgData = imgCtx.getImageData(0,0,imgCanvas.width,imgCanvas.height);
        const code = jsQR(imgData.data,imgData.width,imgData.height);
        if(code){
          processQRCode(code.data);
          log("âœ… ç”»åƒã‹ã‚‰QRã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ");
        } else {
          log("âš ï¸ ç”»åƒã‹ã‚‰QRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        }
      } catch(err){
        log("âŒ ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼: " + err);
      }
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
});

// ã‚«ãƒ¡ãƒ©èµ·å‹•
startCamera();
</script>
</body>
</html>
