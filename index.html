

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä¼šå“¡åˆ¶QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</title>
<style>
  body {font-family: system-ui; background:#f5f6fa; margin:0; padding:1rem; color:#333;}
  h1 {text-align:center;}
  .container {max-width:480px; margin:auto; background:white; border-radius:16px; box-shadow:0 2px 6px rgba(0,0,0,.15); padding:1rem;}
  input, button, select {width:100%; padding:.6rem; margin:.5rem 0; font-size:1rem;}
  video {width:100%; border-radius:10px; margin-top:1rem;}
  #log {font-size:.9rem; margin-top:.5rem; white-space:pre-wrap;}
</style>
</head>
<body>
<h1>QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h1>
<div class="container">
  <h2>QRã‚¹ã‚­ãƒ£ãƒ³ã§ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h2>
  <video id="preview"></video>
  <p id="status">ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...</p>
  <hr>
  <h3>QRã‚³ãƒ¼ãƒ‰ç™ºè¡Œï¼ˆä¼šå“¡ç”¨ï¼‰</h3>
  <input id="memberId" placeholder="ä¼šå“¡IDï¼ˆä¾‹ï¼šA001ï¼‰">
  <input id="memberName" placeholder="æ°åï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒï¼‰">
  <input id="eventName" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹ï¼šç§‹ç¥­ã‚Š2025ï¼‰">
  <button onclick="generateQR()">QRã‚’ç”Ÿæˆ</button>
  <canvas id="qrcanvas"></canvas>
  <div id="log"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script>
  // ğŸ‘‡ã“ã“ã«è‡ªåˆ†ã®GASã®URLã‚’å…¥ã‚Œã¦ãã ã•ã„
  const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbwZpSx-WqgzkIG3cixzbNvXn1aypJgF19kyQGgiJ1lEq0dajAIchqGkB1WJ7YSjrVPj/exec";

  async function sendToSheet(entry){
    try{
      const res = await fetch(GOOGLE_SHEET_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(entry)
      });
      const text = await res.text();
      log(`ğŸ“¤ Google Sheetsé€ä¿¡çµæœ: ${text}`);
    }catch(err){
      log("âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
    }
  }

  function log(t){document.getElementById("log").textContent += t + "\n";}

  // QRç”Ÿæˆ
  function generateQR(){
    const id = memberId.value.trim();
    const name = memberName.value.trim();
    const event = eventName.value.trim();
    if(!id || !name || !event){alert("å…¨é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    const data = JSON.stringify({id,name,event});
    const qr = new QRious({element:document.getElementById("qrcanvas"),value:data,size:200});
    log(`âœ… QRç”Ÿæˆ: ${data}`);
  }

  // ã‚«ãƒ¡ãƒ©èµ·å‹•ã¨ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†
  const video = document.getElementById("preview");
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  async function startCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      video.srcObject = stream;
      video.setAttribute("playsinline", true);
      video.play();
      requestAnimationFrame(tick);
      document.getElementById("status").textContent = "ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³æº–å‚™å®Œäº†";
    }catch(err){
      document.getElementById("status").textContent = "âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + err;
    }
  }

  function tick(){
    if(video.readyState === video.HAVE_ENOUGH_DATA){
      canvas.height = video.videoHeight;
      canvas.width = video.videoWidth;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const img = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(img.data, img.width, img.height);
      if(code){
        try{
          const data = JSON.parse(code.data);
          const entry = {
            member_id:data.id,
            name:data.name,
            event:data.event,
            status:"checked_in"
          };
          sendToSheet(entry);
          document.getElementById("status").textContent = `âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸ: ${data.name} (${data.id})`;
        }catch(e){
          document.getElementById("status").textContent = "âš ï¸ ä¸æ­£ãªQRã§ã™";
        }
      }
    }
    requestAnimationFrame(tick);
  }

  startCamera();
</script>
</body>
</html>
