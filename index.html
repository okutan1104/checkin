<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä¼šå“¡åˆ¶QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</title>
<style>
body{font-family:system-ui;background:#f5f6fa;margin:0;padding:1rem;color:#333;}
h1{text-align:center;margin-bottom:1rem;}
.container{max-width:480px;margin:auto;background:white;border-radius:16px;box-shadow:0 2px 6px rgba(0,0,0,.15);padding:1rem;}
input,button{width:100%;padding:.6rem;margin:.5rem 0;font-size:1rem;}
button{cursor:pointer;}
video{width:100%;border-radius:10px;margin-top:1rem;}
canvas{display:block;margin:1rem auto;}
#log{font-size:.9rem;margin-top:.5rem;white-space:pre-wrap;}
</style>
</head>
<body>
<h1>ä¼šå“¡åˆ¶QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h1>
<div class="container">
<h2>QRã‚¹ã‚­ãƒ£ãƒ³ã§ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h2>
<video id="preview" autoplay playsinline></video>
<p id="status">ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...</p>
<hr>
<h3>ä¼šå“¡QRç”Ÿæˆ</h3>
<input id="memberId" placeholder="ä¼šå“¡IDï¼ˆä¾‹ï¼šA001ï¼‰">
<input id="memberName" placeholder="æ°åï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒï¼‰">
<input id="eventName" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹ï¼šç§‹ç¥­ã‚Š2025ï¼‰">
<button onclick="generateQR()">QRã‚’ç”Ÿæˆ</button>
<canvas id="qrcanvas"></canvas>
<hr>
<h3>ç”»åƒã‹ã‚‰QRã‚¹ã‚­ãƒ£ãƒ³</h3>
<input type="file" id="fileInput" accept="image/*">
<pre id="log"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script>
// ğŸ‘‡ GAS URLï¼ˆã‚ãªãŸã®ã‚‚ã®ã‚’ä½¿ã†ï¼‰
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbyXE45-oFrH5JmhSMuW2iitVcW2VuBorR49hD8yIrVPd59HqxP7zttq2UJIQ8bTcbF9/exec";

function log(t){document.getElementById("log").textContent += t + "\n";}

// === QRç”Ÿæˆ ===
function generateQR(){
  const id = memberId.value.trim();
  const name = memberName.value.trim();
  const event = eventName.value.trim();
  if(!id||!name||!event){alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  const json = JSON.stringify({id,name,event});
  new QRious({element:document.getElementById("qrcanvas"),value:json,size:200});
  log("âœ… QRç”Ÿæˆ: " + json);
}

// === Googleã‚·ãƒ¼ãƒˆé€ä¿¡ ===
async function sendToSheet(entry){
  try{
    const res = await fetch(GOOGLE_SHEET_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(entry)
    });
    log("ğŸ“¤é€ä¿¡çµæœ: " + await res.text());
  }catch(e){
    log("âŒé€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e);
  }
}

// === ã‚«ãƒ¡ãƒ©èµ·å‹•ã¨QRè§£æ ===
const video=document.getElementById("preview");
const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d");

async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
    video.play();
    requestAnimationFrame(tick);
    status.textContent="ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ";
  }catch(e){
    status.textContent="âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + e;
  }
}

function tick(){
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code=jsQR(imgData.data,imgData.width,imgData.height);
    if(code){
      processQRCode(code.data);
    }
  }
  requestAnimationFrame(tick);
}

// === QRã‚³ãƒ¼ãƒ‰å‡¦ç†å…±é€š ===
function processQRCode(qrText){
  try{
    const data=JSON.parse(qrText);
    const entry={member_id:data.id,name:data.name,event:data.event,status:"checked_in"};
    sendToSheet(entry);
    status.textContent=`âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³: ${data.name} (${data.id})`;
  }catch{
    status.textContent="âš ï¸ ä¸æ­£ãªQRã§ã™";
  }
}

// === ç”»åƒã‹ã‚‰QRã‚¹ã‚­ãƒ£ãƒ³ ===
document.getElementById("fileInput").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function() {
    const img = new Image();
    img.onload = function() {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
      const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imgData.data,imgData.width,imgData.height);
      if(code){
        processQRCode(code.data);
      } else {
        log("âš ï¸ QRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
      }
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
});

startCamera();
</script>
</body>
</html>
